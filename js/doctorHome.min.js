var DoctorObj=function(a){this.userNme=$("#userNme");this.popover=$("#custPopover");this.dptNme=$("#dptNme");this.header=$("#header");this.headImg=$("#head-img");this.footer=$("#footer");this.twList=$("#twList");this.dhList=$("#dhList");this.sickList=$("#sickList");this.subPageDiv=$("#subPageDiv");this.sickWrapper=$("#sickWrapper");this.tabs=$("#tabs");this.init()};DoctorObj.prototype.init=function(){mui.init();this.initPage();this.initData();this.bindEvent()};DoctorObj.prototype.initPage=function(){utils.initDivPage("main");$(".content").height($(window).height()-50)};DoctorObj.prototype.initData=function(){var a=this;if(!utils.sliceUrl(location.href).hasOwnProperty("code")){utils.ajax([],"homeAction","doctor",{},function(b,c,d){if(b){a.displayData(d);a.initIM();$.getScript("http://res.wx.qq.com/open/js/jweixin-1.0.0.js",function(f,e,g){a.shareDoctor();window.setTimeout(a.initAdjustTitle(),200)})}})}else{$.getScript("http://res.wx.qq.com/open/js/jweixin-1.0.0.js",function(c,b,d){wxUtils.getWxUserInfo(function(e){a.displayData(e);a.initIM();a.shareDoctor();window.setTimeout(a.initAdjustTitle(),200)})})}};DoctorObj.prototype.bindEvent=function(){var a=this;a.footer.find("li").on("click",function(){var c=$(this);var b=c.attr("opend");if(c.attr("class")=="current"){return}$(this.id).show();if(b!="true"){c.attr("opend","true");if(this.id.indexOf("mySicks")!=-1){(function(e){var d=mui.os.ios?0.003:0.0009;e("#sickWrapper").scroll({bounce:false,indicators:true,deceleration:d});e.ready(function(){e("#sickWrapperDiv").pullToRefresh({up:{auto:true,callback:function(){var f=this;var i=f.element.querySelector("#sickList");var h=document.createDocumentFragment();var g=i.childNodes.length;a.loadMoreData(g,h,function(j){i.appendChild(h);f.endPullUpToRefresh(j<10)})}}})})})(mui)}}$(this.id).show();c.addClass("current");c.siblings("li").each(function(d,e){$(e).removeClass("current");$(this.id).hide()})});a.tabs.children("li").each(function(b,c){$(c).on("click",function(f){var d=$(this).attr("targetId");var g=$("#"+d);g.show();g.siblings().hide()})})};DoctorObj.prototype.displayData=function(a){this.initUserData(userUtils.getUser());this.initHomeData(a)};DoctorObj.prototype.initUserData=function(a){document.title=a.userNme+" 医生";this.userNme.html(a.userNme);this.dptNme.html(a.dptNme);this.headImg.attr("src",a.userIconUrl+"?v="+Date.now())};DoctorObj.prototype.initHomeData=function(c){var e=this;var b=c.homeBizData;this.header.children("li").eq(0).find("p").eq(1).html(b.total.done);this.header.children("li").eq(1).find("p").eq(1).html(b.total.charge);var d=b.tw;$("li[targetId='twList']").find("p>span").html(d.length);if(d.length>0){$.each(d,function(h,k){var g=k.CBuyerPhoneNo;var l=g.slice(0,3);var j=g.slice(g.length-4);var f=$("<li class='mui-table-view-cell mui-media'>											<a href='javascript:;'>																	<div class='doctor-list-icon mui-pull-left'>											<span class='newiconfont icon-xiaoxi'></span>									</div>																				<div class='mui-media-body'>															<div class='doctor-list-name'>															<span class='mui-pull-left'>"+k.CBuyerNme+"</span>				<span class='mui-pull-right'>"+k.TBuyTm+"</span>								</div>																				<p class='mui-ellipsis doctor-list-info mui-col-xs-9 mui-pull-left'>"+(k.CBuyerMsg==undefined?"无":k.CBuyerMsg)+"</p>			<div class='doctor-list-price mui-pull-right'>"+k.finalPrice+"元</div>			<div class='mui-ellipsis mui-pull-left messages'>"+(k.lastMsgOwner!==""?(k.lastMsgOwner+":"+k.lastMsg):"")+"</div>		</div>																			</a>																			</li>");f.attr({orderId:k.COrderId,targetId:k.CBuyerId,roomId:k.COrderId,targetName:k.CBuyerNme,userIcon:k.CBuyerImg,buyerMsg:k.CBuyerNme+"："+k.CBuyerMsg,orderState:1});f.on("click",function(m){var i={orderId:$(this).attr("orderId"),targetId:$(this).attr("targetId"),roomId:$(this).attr("roomId"),targetName:$(this).attr("targetName"),userIcon:$(this).attr("userIcon"),orderState:$(this).attr("orderState"),buyerMsg:$(this).attr("buyerMsg"),sendType:"O",creater:"",role:1,chatType:"single"};var n="wx/page/sessionmsg/chatWindow.html?v="+Date.now();e.gotoPage(n,"talkPageDiv_Main","talkPageDiv_Main");$.publish("/params",[i])});e.twList.children("ul").append(f)})}else{e.twList.children("ul").html("<li class='mui-table-view-cell mui-media doctor-list-no'><span class='newiconfont icon-nodata'></span><p>没有图文待办事项</p></li>")}var a=b.dh;$("li[targetId='dhList']").find("p>span").html(a.length);if(a.length>0){$.each(a,function(g,h){var f=$("<li class='mui-table-view-cell mui-media'>	<a href='javascript:;'>		<div class='doctor-list-icon mui-pull-left'>			<span class='newiconfont icon-dianhua'></span>		</div>		<div class='mui-media-body'>			<div class='doctor-list-name'>				<span class='mui-pull-left'>"+h.CBuyerNme+"</span>				<span class='mui-pull-right'>"+h.TBuyTm+"</span>			</div>			<p class='mui-ellipsis doctor-list-info mui-col-xs-9 mui-pull-left'>"+h.CBuyerMsg+"</p>			<div class='doctor-list-price mui-pull-right'>"+h.finalPrice+"元</div>			<div class='mui-ellipsis mui-pull-left messages'>"+(h.callLong!==""?("<span class='mui-pull-left'>"+h.callTm+"</span><span class='mui-pull-right'>"+h.callLong+"</span>"):"")+"</div>		</div>	</a></li>");f.attr({orderId:h.COrderId,buyerId:h.CBuyerId,});f.on("click",function(){var i="wx/page/mall/orderDesc4Doctor.html?orderId="+h.COrderId;utils.openDivPage(i,"orderDesc4Doctor_main","orderDesc4Doctor_subPage")});e.dhList.children("ul").append(f)})}else{e.dhList.children("ul").html("<li class='mui-table-view-cell mui-media doctor-list-no'><span class='newiconfont icon-nodata'></span><p>没有电话待办事项</p></li>")}};DoctorObj.prototype.initIM=function(){imChat.login(userUtils.getUser().userId,{succFn:function(a){utils.IMFlag=true},fail:function(a){mui.toast(JSON.stringify(a))},error:function(a){mui.toast(JSON.stringify(a))}})};DoctorObj.prototype.gotoSvcSetting=function(a){var c=this;var b=userUtils.getUser().identify;if(b=="A"){utils.openIframePage("main","subPageDiv",a)}else{if(b=="0"){mui.toast("医生认证通过才能设置服务");return}utils.confirm("只有认证的医生才能设置服务，是否现在去设置?",function(){c.gotoDoctorIdentify()},function(){})}};DoctorObj.prototype.gotoWorkSched=function(){var a=userUtils.getUser().identify,b=this;if(a=="A"){b.gotoPage("wx/page/workSched/defaultWorkSched.html","defaultWorkSched_main","subPageDiv")}else{if(a=="0"){mui.toast("医生认证通过才能设置排班");return}utils.confirm("只有认证的医生才能设置排班，是否现在去设置?",function(){b.gotoDoctorIdentify()},function(){})}};DoctorObj.prototype.gotoDoctorIdentify=function(){utils.openDivPage("wx/page/mine/doctorIdentify.html?mrk=add&doctorId="+userUtils.getUser().userId+"&v="+Date.now(),"doctorIdentify_main","doctorIdentify_main");return};DoctorObj.prototype.loadMoreData=function(b,a,d){var c=this;utils.ajax([],"mineAction","mySicks",{firstResult:b,maxResult:10},function(f,g,e){if(f){if(e.result.length>0){$.each(e.result,function(j,n){var m=n.userInfo.childInfo;var l=$("<li class='mui-table-view-cell mui-media'>    <div class='mui-slider-right mui-disabled' userId='"+n.userInfo.CUserId+"' id='slideDel'>        <a class='mui-btn mui-btn-red'>删除</a>    </div>    <div class='mui-slider-handle'>	      <img userId='"+n.userInfo.CUserId+"' userName='"+n.userInfo.CUserNme+"' class='patient-img mui-pull-left' src='"+n.userInfo.CUserIconUrl+"'>	      <div class='mui-media-body childrenAll'>	          <div class='patient-name'>"+n.userInfo.CUserNme+"</div>	  	  </div>    </div></li>");if(m.length>0){for(var k=0;k<m.length;k++){var h=$("<dl class='patient-son' CChildId='"+m[k].CChildId+"' childName='"+m[k].CChildNme+"' CPatientId='"+m[k].CPatientId+"' CPatientRecordId='"+m[k].CPatientRecordId+"'>	          <dt>	              <h4>"+m[k].CChildNme+"</h4>	              <span class='newiconfont "+(m[k].CChildSex=="M"?"icon-nan":"icon-nv")+"'></span>	          </dt>	          <dd class='mui-ellipsis'>"+(m[k].CTag==""?"暂未添加孩子标签信息，请您尽快完善孩子标签信息":m[k].CTag)+"</dd>	      </dl>");if(m.length==1){h.css("width","100%")}l.find("div.childrenAll").append(h)}}l.children("div#slideDel").on("click",function(){c.delMySick(this);return false});l.on("click",function(){$("#custPopover ul").children("li.subLi").remove();var i=$("<li class='subLi' userId='"+n.userInfo.CUserId+"' src='"+n.userInfo.CUserIconUrl+"' userName='"+n.userInfo.CUserNme+"'>发送消息</li>");i.on("click",function(){c.gotoChatWin(this)});$("#custPopover ul").prepend(i);var o="";l.find("dl.patient-son").each(function(p,q){o+="<li class='subLi' onclick='doctorObj_.viewSickDetail(this)' CPatientId='"+$(q).attr("CPatientId")+"' CPatientRecordId='"+$(q).attr("CPatientRecordId")+"' CChildId='"+$(q).attr("CChildId")+"'>"+$(q).attr("childName")+"</li>"});$("#custPopover ul").prepend(o);$("<div>",{"class":"ui-mask",id:"ui-mask",text:"",click:function(){c.popover.slideToggle("fast","swing",function(){$("#ui-mask").remove()})}}).appendTo($("#mySicks"));c.popover.slideToggle("fast","swing")});a.appendChild(l.get(0))});if(d){d(e.result.length)}}else{if(d){d(0)}}}},function(g,e,f){alert("error")},false)};DoctorObj.prototype.gotoChatWin=function(b){var c=this;$("#ui-mask").trigger("click");var a={roomId:$(b).attr("userId"),targetId:$(b).attr("userId"),targetName:$(b).attr("userName"),userIcon:$(b).attr("src"),orderId:"",sendType:"F",creater:"",role:"1",chatType:"single"};c.gotoPage("wx/page/sessionmsg/chatWindow.html?v="+Date.now(),"talkPageDiv_Main","talkPageDiv_Main");$.publish("/params",[a])};DoctorObj.prototype.delMySick=function(b){var a=$(b).attr("userId");utils.confirm("是否删除该患者",function(){utils.ajax([],"mineAction","delUserRel",{relUserId:a},function(c,d,e){mui.toast("删除成功");$(b).parent().remove()},function(){mui.toast("删除失败")})},function(){})};DoctorObj.prototype.gotoDoctorCard=function(){var a=userUtils.getUser().identify,b=this;if(a=="A"){b.gotoPage("wx/page/mine/doctorCardNew.html","doctorCard_main","doctorCard_main")}else{if(a=="0"){mui.toast("医生认证通过才能查看名片");return}utils.confirm("只有认证的医生才能查看自己名片，是否现在去设置?",function(){b.gotoDoctorIdentify()},function(){})}};DoctorObj.prototype.gotoTollSet=function(){var a=userUtils.getUser().identify,b=this;if(a=="A"){location.href="mine/svcSetting.html"}else{if(a=="0"){mui.toast("医生认证通过才能设置收费");return}utils.confirm("只有认证的医生才能设置收费，是否现在去设置?",function(){b.gotoDoctorIdentify()},function(){})}};DoctorObj.prototype.gotoPage=function(c,a,b){if(c=="*"){mui.toast("功能开发中");return}if(c.indexOf("doctorIdentify.html")!=-1){c+="&doctorId="+userUtils.getUser().userId}if(c.indexOf("?")!=-1){c=c+"&v="+Date.now()}else{c=c+"?v="+Date.now()}utils.openDivPage(c,a,b)};DoctorObj.prototype.gotoInfoList=function(){location.href="infomation/infoList.html?v="+Date.now()};DoctorObj.prototype.gotoMyInfoList=function(){location.href="infomation/infoList.html?articleOwnerId="+userUtils.getUser().userId+"&v="+Date.now()};DoctorObj.prototype.gotoMyCollection=function(){this.gotoPage("wx/page/mine/myCollection.html?v="+Date.now(),"myCollection_main","myCollection_main")};DoctorObj.prototype.initAdjustTitle=function(){var a=userUtils.getUser().identify,b=this;if(a=="A"){$("#identified").show()}else{if(a=="0"){$("#adjusting").show()}else{$("#noIdentify").show();if(a=="0"){return}utils.confirm("只有认证的医生才能为患者提供服务，<br>是否现在去设置?",function(){b.gotoDoctorIdentify()},function(){})}}};DoctorObj.prototype.invitePatients=function(){var c=userUtils.getUser().identify,g=this;if(c=="A"){var f=userUtils.getUser().userId,e=userUtils.getUser().userNme,d=userUtils.getUser().dptNme,a=userUtils.getUser().officeNme,b="wx/page/about/invitePatients.html?doctorId="+f+"&doctorNme="+e+"&dptNme="+d+"&officeNme="+a+"&v="+Date.now();g.gotoPage(b,"invitePatients_main","subPageDiv")}else{if(c=="0"){mui.toast("医生认证通过才能邀请患者");return}utils.confirm("只有认证的医生才能邀请患者，是否现在去设置?",function(){g.gotoDoctorIdentify()},function(){})}};DoctorObj.prototype.inviteDoctor=function(){var c=userUtils.getUser().identify,g=this;if(c=="A"){var f=userUtils.getUser().userId,e=userUtils.getUser().userNme,d=userUtils.getUser().dptNme,a=userUtils.getUser().officeNme,b="wx/page/about/inviteDoctor.html?doctorId="+f+"&doctorNme="+e+"&dptNme="+d+"&officeNme="+a+"&v="+Date.now();g.gotoPage(b,"invateDoctor_main","invateDoctor_main")}else{if(c=="0"){mui.toast("医生认证通过才能邀请医生");return}utils.confirm("只有认证的医生才能邀请医生，是否现在去设置?",function(){g.gotoDoctorIdentify()},function(){})}};DoctorObj.prototype.shareDoctor=function(){var a=["onMenuShareQQ","onMenuShareAppMessage","onMenuShareQZone","onMenuShareTimeline","chooseWXPay"];wxUtils.wxConfig(a,function(){var f="掌尚儿保医助",e="掌尚儿保诚挚的邀请您一同开通医生云工作站，欢迎点击关注!!",c="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7108786cb171967b&redirect_uri="+utils.APP_URL_+"/wx/page/doctorHome_.html&response_type=code&scope=snsapi_userinfo&state={type:DOCTOR}#wechat_redirect",g="http://7xq2xm.com2.z0.glb.qiniucdn.com/zseb_yz.jpg",b="",d="";wxUtils.wxShare(f,e,c,g,b,d)})};DoctorObj.prototype.viewSickDetail=function(a){var c=this,b="wx/page/mine/childForSick.html?CPatientId="+$(a).attr("CPatientId")+"&ChildId="+$(a).attr("CChildId")+"&CPatientRecordId="+$(a).attr("CPatientRecordId");c.gotoPage(b,"childForSick_main","subPageDiv");$("#ui-mask").trigger("click")};var doctorObj_=null;if(!doctorObj_){doctorObj_=new DoctorObj()};